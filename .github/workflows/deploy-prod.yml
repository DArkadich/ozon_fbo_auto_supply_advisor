name: üöÄ Deploy Ozon FBO Auto Supply Advisor to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: üîß Build & Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
      - name: üîç Validate deployment secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.SERVER_USER }}" ] || [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "‚ùå Missing one or more server secrets (SERVER_HOST, SERVER_USER, SERVER_SSH_KEY)"
            exit 1
          else
            echo "‚úÖ All required secrets are set"
          fi

      # 3Ô∏è‚É£ –õ–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: üß† Debug environment info
        run: |
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Branch: $GITHUB_REF"
          echo "Actor: $GITHUB_ACTOR"

      # 4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
      - name: üß™ Run tests and type checks
        run: |
          pip install -r requirements.txt pytest pytest-asyncio pytest-cov mypy
          PYTHONPATH=src pytest -q --disable-warnings --maxfail=1
          mypy src || true

      # 5Ô∏è‚É£ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ SSH
      - name: üöÄ Deploy to server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            echo "üîê Connected to $HOST"

            # –ü–∞–ø–∫–∞ –¥–µ–ø–ª–æ—è
            APP_DIR="/home/denis/bots/ozon_fbo_auto_supply_advisor"

            echo "üìÅ Deploying to $APP_DIR"

            # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç
            mkdir -p $APP_DIR

            cd $APP_DIR

            # –ï—Å–ª–∏ git –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º
            if [ ! -d ".git" ]; then
              echo "üì¶ Initializing repository..."
              git clone https://github.com/DArkadich/ozon_fbo_auto_supply_advisor.git .
            fi

            echo "üì• Updating code..."
            git fetch --all
            git reset --hard origin/main

            echo "üê≥ Starting Docker containers..."
            docker compose -f docker-compose.yml pull || true
            docker compose -f docker-compose.yml up -d --build

            echo "üßπ Cleaning old Docker images..."
            docker image prune -af || true

            echo "‚úÖ Deployment finished successfully!"

      # 6Ô∏è‚É£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: üì£ Notify success
        if: success()
        run: echo "‚úÖ Deployment to production completed successfully!"

      # 7Ô∏è‚É£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—É–¥–∞—á–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: ‚ö†Ô∏è Notify failure
        if: failure()
        run: echo "‚ùå Deployment failed. Check GitHub Actions logs."
