name: üöÄ Deploy Ozon FBO Advisor to Production

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: üß™ Run Tests & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 mypy black

      - name: Run pre-commit checks
        run: |
          pip install pre-commit
          pre-commit run --all-files

      - name: Run tests
        env:
          OZON_CLIENT_ID: dummy
          OZON_API_KEY: dummy
          TELEGRAM_TOKEN: dummy
        run: |
          PYTHONPATH=src pytest -q --disable-warnings --maxfail=1 --cov=src

  deploy:
    name: üöÄ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "=== üîÅ Starting deploy on $(hostname) ==="
            cd /opt/ozon-fbo-advisor || exit 1
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            echo "Stopping old containers..."
            docker compose down
            echo "Building and starting new containers..."
            docker compose up -d --build
            docker system prune -f
            echo "‚úÖ Deployment complete!"
