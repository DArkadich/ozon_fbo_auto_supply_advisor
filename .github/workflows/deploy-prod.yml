name: üöÄ Deploy Ozon FBO Advisor to Production (v1.3.7 CI-Patched)

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: üß™ Build, Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install types-requests mypy pytest-asyncio


      - name: Run pre-commit checks (black, flake8, mypy, pytest)
        run: |
          pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure

      - name: Run unit tests separately (with coverage)
        env:
          OZON_CLIENT_ID: dummy
          OZON_API_KEY: dummy
          TELEGRAM_TOKEN: dummy
          TELEGRAM_CHAT_ID: dummy
        run: |
          PYTHONPATH=src pytest -q --disable-warnings --maxfail=1 --cov=src

  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "=== üîÅ Starting deploy on $(hostname) ==="
            cd /opt/ozon-fbo-advisor || exit 1
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            echo "Stopping old containers..."
            docker compose down
            echo "Building and starting new containers..."
            docker compose up -d --build
            docker system prune -f
            echo "‚úÖ Deployment complete!"

      - name: Healthcheck (verify app is alive)
        run: |
          sleep 5
          curl -fsS http://${{ secrets.SSH_HOST }}:8000/health || exit 1

      - name: Notify Telegram on success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            ‚úÖ *Ozon FBO Advisor deployed successfully!*
            Commit: `${{ github.sha }}`
            Author: `${{ github.actor }}`
            Repository: `${{ github.repository }}`
            Branch: `${{ github.ref_name }}`
